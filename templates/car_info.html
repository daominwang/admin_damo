{% extends 'index.html' %}

{% block content_css %}
    <style>
        .layui-form-pane .layui-form-label {
            width: 160px;
        }

        .layui-form {
            margin-top: 20px;
            margin-left: 100px;
        }

        .layui-form-item .layui-input-inline {
            width: 250px;
        }

        .layui-layedit {
            width: calc(100% - 100px);
        }

        #car_img_preview {
            max-height: 300px;
        }
    </style>
{% endblock %}

{% block content %}
    <div style="display: block;">
        <form class="layui-form layui-form-pane">
            <div class="layui-form-item layui-hide">
                <label class="layui-form-label">id</label>
                <div class="layui-input-inline">
                    <input type="number" min="0" name="id" value="{{ car.id or '' }}">
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">车型图片</label>
                    <button type="button" class="layui-btn layui-btn-danger" id="img"><i class="layui-icon"></i>上传图片</button>
                    <div class="layui-upload-list">
                        <img class="layui-upload-img" id="car_img_preview" src="{{ car.img or '' }}">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">车型</label>
                    <div class="layui-input-inline">
                        <select name="car_type">
                            {% for item in car_type_list %}
                                <option value="{{ item.car_type }}" {{ 'selected' if car.car_type and item.car_type == car.car_type else '' }}>{{ item.car_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">标题</label>
                    <div class="layui-input-inline">
                        <input type="text" name="car_title" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.car_title or '' }}">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">类型</label>
                    <div class="layui-input-inline">
                        <select name="classification">
                            {% for item in classification_list %}
                                <option value="{{ item.classification }}" {{ 'selected' if car.classification and item.classification == car.classification else '' }}>{{ item.classification }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">城市</label>
                    <div class="layui-input-inline">
                        <select name="city">
                            <option value="成都市">成都市</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">库存</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="car_left" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.car_left or 0 }}">
                    </div>
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>原价</legend>
            </fieldset>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">日租价</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="day_rent_original" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.day_rent_original or 0 }}">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">押金(预授权)</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="deposit_original" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.deposit_original or 0 }}">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">每日限里程数(公里)</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="mileage_limit_per_day_original" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.mileage_limit_per_day_original or 0 }}">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">超公里费(每公里)</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="ext_mileage_pay_original" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.ext_mileage_pay_original or 0 }}">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">超时费(每小时)</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="ext_time_pay_original" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.ext_time_pay_original or 0 }}">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">包月价</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="month_rent_original" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.month_rent_original or 0 }}">
                    </div>
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>活动价</legend>
            </fieldset>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">日租价</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="day_rent_actual" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.day_rent_actual or 0 }}">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">押金(预授权)</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="deposit_actual" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.deposit_actual or 0 }}">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">每日限里程数(公里)</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="mileage_limit_per_day_actual" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.mileage_limit_per_day_actual or 0 }}">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">超公里费(每公里)</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="ext_mileage_pay_actual" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.ext_mileage_pay_actual or 0 }}">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">超时费(每小时)</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="ext_time_pay_actual" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.ext_time_pay_actual or 0 }}">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">包月价</label>
                    <div class="layui-input-inline">
                        <input type="number" min="0" name="month_rent_actual" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ car.month_rent_actual or 0 }}">
                    </div>
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>描述</legend>
            </fieldset>

            <div class="layui-form-item">
                <div id="car_desc"></div>
                <textarea class="layui-hide" name="car_desc_hidden">{{ car.car_desc or '' }}</textarea>
            </div>

            <div class="layui-form-item" style="margin-left: 250px">
                <div class="layui-inline">
                    <button class="layui-btn" lay-submit="" lay-filter="save">保存</button>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn" lay-submit="" lay-filter="cancel">取消并返回</button>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block content_javascript %}
    <script>
        document.onkeydown = function () {
            if (event.ctrlKey === true && event.keyCode === 83) {//Ctrl+S
                event.returnvalue = false;
                console.log('触发ctrl+s');
                $('button[lay-filter=save]').click();
                return false;
            }

        };
        var layer, form, index, upload;

        var E = window.wangEditor;
        var editor = new E('#car_desc');
        editor.customConfig.uploadImgServer = '/upload';
        editor.customConfig.menus = ['head', 'bold', 'fontSize', 'fontName', 'italic', 'underline', 'strikeThrough', 'foreColor', 'backColor', 'link', 'list', 'justify', 'quote', 'emoticon', 'image', 'table', 'undo', 'redo'];
        editor.customConfig.uploadImgHooks = {
            customInsert: function (insertImg, result, editor) {
                if (result.code === 200) {
                    insertImg(result.data.src)
                } else {
                    layer.msg('图片上传失败，请稍候重试', {icon: 5, time: 3000, shade: [0.8, '#393D49'], shadeClose: true}, function () {
                        layer.closeAll();
                    })
                }
            }
        };
        editor.create();
        var car_desc = $('textarea[name=car_desc_hidden]').text();
        editor.txt.html(car_desc);

        layui.use(['layer', 'form'], function () {
            layer = layui.layer;
            form = layui.form;
            form.on('submit(save)', function (data) {
                data.field.car_desc = editor.txt.html();
                data.field.img = $('#car_img_preview').attr('src');
                $.post('', data.field, function (res) {
                    if (res.code === 200) {
                        layer.msg('保存成功', {icon: 1, time: 1000, shade: [0.8, '#393D49'], shadeClose: true}, function () {
                            window.location.href = '{{ url_for('view.car_manage') }}';
                        })
                    } else {
                        layer.msg(res.msg, {icon: 5, time: 3000, shade: [0.8, '#393D49'], shadeClose: true}, function () {
                            layer.closeAll();
                        })
                    }
                }, 'json');
                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
            });
            form.on('submit(cancel)', function () {
                window.location.href = '{{ url_for('view.car_manage') }}';
                return false;
            })
        });

        layui.use('upload', function () {
            upload = layui.upload;
            var upload_data;
            upload.render({
                elem: '#img'
                , url: '{{ url_for('view.upload') }}'
                , before: function (obj) {
                    upload_data = obj;
                }
                , done: function (res) {
                    if (res.code !== 200) {
                        return layer.alert('上传失败，请重试', {icon: 5, time: 3000})
                    } else {
                        upload_data.preview(function () {
                            $('#car_img_preview').attr('src', res.data.src);
                        });
                    }
                }
                , error: function () {
                    return layer.alert('上传失败，请重试', {icon: 5, time: 3000})
                }
            })
        });
    </script>
{% endblock %}